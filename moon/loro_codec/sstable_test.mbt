test "sstable: roundtrip simple" {
  let kvs: Array[(Bytes, Bytes)] = [
    (b"a", b"1"),
    (b"ab", b"2"),
    (b"b", b""),
    (b"c", b"ccc"),
  ]
  let encoded = sstable_export_all(kvs, 128) catch { EncodeError(_) => b"" }
  let decoded = sstable_import_all(encoded, true) catch { DecodeError(_) => [] }
  assert_eq(decoded, kvs)
}

test "sstable: large value block" {
  let kvs: Array[(Bytes, Bytes)] = [(b"k", b"0123456789abcdef")]
  let encoded = sstable_export_all(kvs, 8) catch { EncodeError(_) => b"" }
  let decoded = sstable_import_all(encoded, true) catch { DecodeError(_) => [] }
  assert_eq(decoded, kvs)
}

test "sstable: multiple blocks split" {
  let kvs: Array[(Bytes, Bytes)] = [
    (b"a", b"11111111"),
    (b"aa", b"22222222"),
    (b"aaa", b"33333333"),
  ]
  let encoded = sstable_export_all(kvs, 16) catch { EncodeError(_) => b"" }
  let decoded = sstable_import_all(encoded, true) catch { DecodeError(_) => [] }
  assert_eq(decoded, kvs)
}

fn repeat_byte(byte: Byte, n: Int) -> Bytes {
  let w = BytesWriter::new()
  for _i in 0..<n {
    w.write_u8(byte)
  }
  w.to_bytes()
}

test "sstable: decode rust fixture (lz4 + large block)" {
  // Generated by Rust `loro-kv-store` MemKvStore with:
  // - block_size = 64
  // - compression = LZ4
  // - kvs: a/ab/ac => 10x 'a', z => 200x 'z'
  let fixture =
    b"\x4C\x4F\x52\x4F\x00\x04\x22\x4D\x18\x60\x40\x82\x1D\x00\x00\x00\x15\x61\x01\x00\x55\x00\x02\x00\x61\x62\x0E\x00\x67\x61\x00\x02\x00\x61\x63\x0F\x00\x70\x00\x0A\x00\x19\x00\x03\x00\x00\x00\x00\x00\x1C\x44\xC3\x37\x04\x22\x4D\x18\x60\x40\x82\x0C\x00\x00\x00\x1F\x7A\x01\x00\xAE\x60\x7A\x7A\x7A\x7A\x7A\x7A\x00\x00\x00\x00\xC5\xE2\xB4\x79\x02\x00\x00\x00\x05\x00\x00\x00\x01\x00\x61\x01\x02\x00\x61\x63\x35\x00\x00\x00\x01\x00\x7A\x81\xFF\xA8\xF1\x0F\x54\x00\x00\x00"

  let decoded = try! sstable_import_all(fixture, true)
  let expected: Array[(Bytes, Bytes)] = [
    (b"a", repeat_byte(b'a', 10)),
    (b"ab", repeat_byte(b'a', 10)),
    (b"ac", repeat_byte(b'a', 10)),
    (b"z", repeat_byte(b'z', 200)),
  ]
  assert_eq(decoded, expected)
}
